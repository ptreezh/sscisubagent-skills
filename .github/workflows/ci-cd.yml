name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

env:
  PYTHON_VERSION: '3.8'

jobs:
  # ============================================
  # 代码质量检查
  # ============================================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Run Black (code formatter check)
      run: |
        black --check --diff agents/ skills/ --exclude "archive/" --exclude "project_backup/" --exclude "desktop_design/"

    - name: Run isort (import sorting check)
      run: |
        isort --check-only --diff agents/ skills/ --skip "archive/" --skip "project_backup/" --skip "desktop_design/"

    - name: Run Flake8 (linting)
      run: |
        flake8 agents/ skills/ \
          --exclude="archive*,project_backup*,desktop_design*/node_modules" \
          --max-line-length=100 \
          --extend-ignore=E203,W503

    - name: Check YAML syntax
      run: |
        pip install pyyaml
        python -c "
        import yaml
        import sys
        import glob

        files = glob.glob('**/*.md', recursive=True)
        files += glob.glob('**/*.yml', recursive=True)
        files += glob.glob('**/*.yaml', recursive=True)

        errors = []
        for f in files:
            if any(x in f for x in ['archive/', 'project_backup/', 'node_modules']):
                continue
            try:
                if f.endswith('.md'):
                    with open(f, 'r', encoding='utf-8') as file:
                        content = file.read()
                        if '---' in content[:200]:
                            yaml.safe_load(content.split('---')[1])
            except Exception as e:
                errors.append(f'{f}: {str(e)}')

        if errors:
            print('YAML syntax errors:')
            for error in errors:
                print(f'  - {error}')
            sys.exit(1)
        "

  # ============================================
  # Python语法检查
  # ============================================
  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Check Python syntax
      run: |
        echo "Checking Python files..."
        find . -name "*.py" \
          -not -path "./.venv/*" \
          -not -path "./venv/*" \
          -not -path "./env/*" \
          -not -path "./archive/*" \
          -not -path "./project_backup/*" \
          -not -path "./desktop_design/*/node_modules/*" \
          -exec python -m py_compile {} \; \
          -print

        echo "All Python files passed syntax check!"

  # ============================================
  # 技能文件验证
  # ============================================
  skills-validation:
    name: Skills Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml

    - name: Validate SKILL.md files
      run: |
        python .github/scripts/validate_skills.py

    - name: Check YAML frontmatter
      run: |
        python .github/scripts/check_yaml_frontmatter.py

  # ============================================
  # 作者信息一致性检查
  # ============================================
  author-check:
    name: Author Info Consistency
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Check author information
      run: |
        python .github/scripts/check_author_info.py

  # ============================================
  # 构建和测试
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ${{ matrix.os }}
    needs: [lint, syntax-check, skills-validation, author-check]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

    - name: Run tests
      run: |
        python -m pytest tests/ -v --tb=short || echo "No tests found, skipping..."

    - name: Test skill imports
      run: |
        python .github/scripts/test_skill_imports.py

  # ============================================
  # 文档生成
  # ============================================
  docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install markdown

    - name: Generate skills inventory
      run: |
        python .github/scripts/generate_inventory.py > COMPLETE_SKILLS_INVENTORY.md

    - name: Upload documentation
      uses: actions/upload-artifact@v3
      with:
        name: documentation
        path: |
          COMPLETE_SKILLS_INVENTORY.md
          README.md
          CHANGELOG.md

  # ============================================
  # 发布到agentskills.io
  # ============================================
  publish-to-marketplace:
    name: Publish to AgentSkills.io
    runs-on: ubuntu-latest
    needs: [build-and-test, docs]
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml

    - name: Publish skills
      env:
          AGENTSKILLS_API_KEY: ${{ secrets.AGENTSKILLS_API_KEY }}
      run: |
        python .github/scripts/publish_to_agentskills.py

    - name: Create release summary
      run: |
        echo "# Release Summary" > release_summary.md
        echo "" >> release_summary.md
        echo "Published $(date +%Y-%m-%d)" >> release_summary.md
        echo "" >> release_summary.md
        echo "## Published Skills" >> release_summary.md
        python .github/scripts/list_published_skills.py >> release_summary.md

  # ============================================
  # 自动创建Changelog
  # ============================================
  changelog:
    name: Update Changelog
    runs-on: ubuntu-latest
    needs: [publish-to-marketplace]
    if: github.event_name == 'release'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      run: |
        python .github/scripts/generate_changelog.py >> CHANGELOG.md

    - name: Commit changelog
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add CHANGELOG.md
        git commit -m "docs: update changelog for ${{ github.event.release.tag_name }}" || echo "No changes to commit"
        git push
