name: CI/CD Pipeline for SSCI Skills
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday 2AM

jobs:
  # Code Quality Checks
  code-quality:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
        pip install -r requirements.txt 2>/dev/null || true

    - name: Code formatting check
      run: |
        black --check .
        isort --check-only .

    - name: Linting
      run: |
        flake8 . --max-line-length=88 --extend-ignore=E203,W503

    - name: Type checking
      run: |
        mypy . --ignore-missing-imports --strict-optional

  # TDD Test Suite
  tdd-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install uv (if available)
      run: |
        if command -v uv >/dev/null 2>&1; then
          pip install uv
        fi

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install python-tk

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-mock pytest-asyncio
        pip install jieba networkx pandas numpy matplotlib seaborn
        pip install flask flask-cors requests werkzeug
        pip install psutil  # For performance testing

    - name: Run Smart Deployer TDD Tests
      run: |
        python -m pytest tests/integration/test_smart_deployer_tdd.py -v --cov=smart_deploy --cov-report=xml

    - name: Run Skills Launcher TDD Tests
      run: |
        python -m pytest tests/integration/test_skills_launcher_tdd.py -v --cov=skills_launcher --cov-report=xml

    - name: Run Web Interface TDD Tests
      run: |
        python -m pytest tests/integration/test_web_interface_tdd.py -v --cov=web_interface --cov-report=xml

    - name: Run End-to-End Automation Tests
      run: |
        python -m pytest tests/e2e/test_end_to_end_automation.py -v --cov=e2e_automation --cov-report=xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # Integration Tests
  integration-tests:
    runs-on: ${{ matrix.os }}
    needs: tdd-tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
        pip install jieba networkx pandas numpy

    - name: Test Smart Deployment
      run: |
        python smart_deploy.py --diagnose
        python smart_deploy.py --guide

    - name: Test Skills Launcher
      run: |
        timeout 10 python skills_launcher.py --welcome || true

    - name: Test Web Interface (background)
      run: |
        timeout 5 python web_interface.py & || true

    - name: Validate skill structure
      run: |
        python -c "
        import os
        print('Skills directory:', os.path.exists('skills'))
        if os.path.exists('skills'):
            for root, dirs, files in os.walk('skills'):
                level = root.replace('skills', '').count(os.sep)
                indent = ' ' * 2 * level
                print(f'{indent}{os.path.basename(root)}/')
                subindent = ' ' * 2 * (level + 1)
                for file in files:
                    print(f'{subindent}{file}')
        "

  # Performance Tests
  performance-tests:
    runs-on: ubuntu-latest
    needs: integration-tests

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-benchmark
        pip install -r requirements.txt

    - name: Run performance benchmarks
      run: |
        python -m pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark.json

  # Security Tests
  security-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install security tools
      run: |
        pip install bandit safety
        pip install -r requirements.txt

    - name: Run bandit security linter
      run: |
        bandit -r . -f json -o bandit-report.json || true

    - name: Check dependencies for known vulnerabilities
      run: |
        safety check --json --output safety-report.json || true

    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-reports
        path: "*-report.json"

  # Documentation Tests
  docs-tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install documentation tools
      run: |
        pip install mkdocs mkdocs-material

    - name: Validate documentation structure
      run: |
        if [ -f "mkdocs.yml" ]; then
          mkdocs build --strict
        fi

    - name: Check README files
      run: |
        find . -name "README*" -exec echo "Found: {}" \;
        for readme in $(find . -name "README*"); do
          echo "Checking $readme..."
          if [ -s "$readme" ]; then
            echo "‚úì $readme is not empty"
          else
            echo "‚úó $readme is empty"
            exit 1
          fi
        done

  # Build and Package
  build-package:
    runs-on: ubuntu-latest
    needs: [tdd-tests, integration-tests]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install build tools
      run: |
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist/

  # Deployment (only on main branch)
  deploy:
    runs-on: ubuntu-latest
    needs: [tdd-tests, integration-tests, performance-tests, security-tests, docs-tests, build-package]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: dist
        path: dist/

    - name: Deploy to PyPI (if configured)
      if: env.PYPI_API_TOKEN != ''
      env:
        PYPI_API_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        pip install twine
        twine upload dist/* --username __token__ --password $PYPI_API_TOKEN

    - name: Create Release
      if: env.GITHUB_TOKEN != ''
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.run_number }}
        release_name: Release ${{ github.run_number }}
        draft: false
        prerelease: false

  # Notification
  notify:
    runs-on: ubuntu-latest
    needs: [tdd-tests, integration-tests, performance-tests, security-tests, docs-tests, build-package]
    if: always()

    steps:
    - name: Notify on success
      if: needs.deploy.result == 'success'
      run: |
        echo "‚úÖ CI/CD Pipeline completed successfully!"
        echo "üöÄ Deployment completed successfully!"

    - name: Notify on failure
      if: failure()
      run: |
        echo "‚ùå CI/CD Pipeline failed!"
        echo "üîß Please check the logs and fix the issues"

    - name: Notify on skipped
      if: cancelled()
      run: |
        echo "‚è≠Ô∏è CI/CD Pipeline was cancelled"